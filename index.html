<!DOCTYPE html>
<html>

<head>
    <title>Download center</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js"></script>
    <style>
        :root {
            --primary-color: #0067a5;
            --accent-color: #0086d6;
            --light-bg: #f5f9fc;
            --header-height: 60px;
            --sidebar-width: 240px;
            --folder-color: #2666a3;
            --danger-color: #e53935;
            --help-button-bg: #a7d7a7;
            --help-button-hover-bg: #8bc38b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: #333;
            line-height: 1.6;
            direction: ltr;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: white;
            height: var(--header-height);
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo img {
            height: 36px;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            background-color: var(--primary-color);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .action-buttons button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9rem;
        }

        .action-buttons button:hover {
            background-color: var(--accent-color);
        }

        .main-content {
            margin-top: var(--header-height);
            display: flex;
            flex-direction: column;
            padding: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        #files-view {
            display: flex;
            flex-direction: column;
        }

        .programs-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 40px;
            height: calc(100vh - 140px);
        }

        .page-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #333;
        }

        .breadcrumb-nav {
            margin-bottom: 20px;
            color: #666;
            font-size: 0.9rem;
        }

        .file-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 0;
            max-width: 100%;
            overflow-y: auto;
            padding-right: 8px;
        }

        .file-grid::-webkit-scrollbar {
            width: 8px;
        }

        .file-grid::-webkit-scrollbar-track {
            background-color: #f1f1f1;
            border-radius: 4px;
        }

        .file-grid::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        }

        .file-grid::-webkit-scrollbar-thumb:hover {
            background-color: #999;
        }

        .item-card {
            background-color: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            flex-direction: row;
            align-items: center;
            text-align: left;
            gap: 15px;
        }

        .item-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
            background-color: #f9f9f9;
        }

        .item-card.selected {
            border-color: var(--primary-color);
            background-color: var(--light-bg);
            box-shadow: 0 4px 12px rgba(0, 102, 165, 0.2);
        }

        .folder-icon,
        .item-icon {
            width: 40px;
            height: 40px;
            min-width: 40px;
            color: var(--folder-color);
            flex-shrink: 0;
        }

        .item-name {
            font-weight: 500;
            margin-bottom: 0;
            word-break: break-word;
            flex: 1;
        }

        .item-info {
            font-size: 0.8rem;
            color: #999;
            white-space: nowrap;
        }

        .status-message {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .status-message.info {
            background-color: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }

        .status-message.success {
            background-color: #e8f5e9;
            color: #388e3c;
            border: 1px solid #c8e6c9;
        }

        .status-message.error {
            background-color: #ffebee;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #999;
        }

        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        }

        .login-card {
            background: white;
            border-radius: 8px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
        }

        .login-title {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.8rem;
        }

        .login-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
            transition: background-color 0.2s;
        }

        .login-button:hover {
            background-color: var(--accent-color);
        }

        .login-message {
            margin-top: 15px;
            color: #666;
            font-size: 0.9rem;
        }

        .error-message {
            color: var(--danger-color);
            padding: 10px;
            margin-bottom: 15px;
            background-color: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 4px;
        }

        .help-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 999;
            padding: 0;
            border: none;
            background-color: var(--help-button-bg);
        }

        .help-button:hover {
            background-color: var(--help-button-hover-bg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: scale(1.1);
        }

        .help-button svg {
            width: 24px;
            height: 24px;
            stroke: #333;
            stroke-width: 2;
        }

        .program-details {
            margin-top: 0;
            display: none;
            overflow-y: auto;
            padding-right: 8px;
        }

        .program-details::-webkit-scrollbar {
            width: 8px;
        }

        .program-details::-webkit-scrollbar-track {
            background-color: #f1f1f1;
            border-radius: 4px;
        }

        .program-details::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        }

        .program-details::-webkit-scrollbar-thumb:hover {
            background-color: #999;
        }

        .program-details.visible {
            display: block;
        }

        .program-details h2 {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #333;
        }

        .versions-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        .versions-table-obsolete {
            margin-top: 25px;
        }

        .versions-table thead {
            background-color: var(--primary-color);
            color: white;
        }

        .versions-table th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--primary-color);
        }

        .versions-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .versions-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .versions-table a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .versions-table a:hover {
            text-decoration: underline;
        }

        .versions-table-latest tbody tr {
            background-color: #d4edda;
        }

        .versions-table-latest tbody tr td {
            padding: 12px 15px;
        }

        .back-button {
            background-color: #f1f1f1;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 15px;
            transition: all 0.2s;
        }

        .back-button:hover {
            background-color: #e1e1e1;
            border-color: #999;
        }

        .unauthorized-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        }

        .unauthorized-card {
            background: white;
            border-radius: 8px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 500px;
        }

        .unauthorized-card h2 {
            color: var(--danger-color);
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .unauthorized-card p {
            color: #666;
            margin-bottom: 20px;
            font-size: 1rem;
            line-height: 1.6;
        }

        .unauthorized-card button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .unauthorized-card button:hover {
            background-color: var(--accent-color);
        }
    </style>
</head>

<body>
    <header>
        <div class="logo">
            <img src="logo.png" alt="Logo">
            <h1>Download Center</h1>
        </div>
        <div id="user-section" class="user-section">
            <div id="user-info" class="user-info" style="display: none;">
                <div class="user-avatar" id="user-avatar">TU</div>
                <span id="username">Test User</span>
            </div>
            <div class="action-buttons">
                <button id="login-header-button" style="display: none;">Login</button>
                <button id="logout-button" style="display: none;">Logout</button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div id="login-view" class="login-container" style="display: none;">
            <div class="login-card">
                <h2 class="login-title">Welcome to AEI Download Center</h2>
                <p>Please sign in to access files.</p>
                <div id="login-error" class="error-message" style="display: none;"></div>
                <div id="loading-spinner" class="loading" style="display: none;">Logging in...</div>
                <button id="login-button" class="login-button">Sign In with Microsoft</button>
                <p class="login-message">Secure access to support resources.</p>
            </div>
        </div>

        <div id="unauthorized-view" class="unauthorized-container" style="display: none;">
            <div class="unauthorized-card">
                <h2>Access Denied</h2>
                <p>Your account does not have permission to access this resource. Please contact your administrator if you believe this is an error.</p>
                <button id="logout-unauthorized-button">Sign Out</button>
            </div>
        </div>

        <div id="files-view" style="display: none;">
            <h1 class="page-title">Programs</h1>

            <div class="programs-container">
                <div id="files-list" class="file-grid">
                    <!-- Cards will be generated dynamically from programs.json -->
                </div>

                <div id="program-details" class="program-details">
                    <h2 id="program-title">Program Versions</h2>
                    <table class="versions-table versions-table-latest">
                        <thead>
                            <tr>
                                <th>Program</th>
                                <th>Version</th>
                                <th>Link</th>
                                <th>Release Note</th>
                            </tr>
                        </thead>
                        <tbody id="versions-tbody-latest">
                            <!-- Latest version will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                    <h3 style="margin-top: 30px; margin-bottom: 15px; color: #333; font-size: 1.1rem;">Previous</h3>
                    <table class="versions-table versions-table-obsolete">
                        <thead>
                            <tr>
                                <th>Program</th>
                                <th>Version</th>
                                <th>Link</th>
                                <th>Release Note</th>
                            </tr>
                        </thead>
                        <tbody id="versions-tbody-obsolete">
                            <!-- Obsolete versions will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                    <button class="back-button" id="back-button">‚Üê Back to Programs</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Help Button -->
    <button id="help-button" class="help-button" title="Help">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 16v-4M12 8h.01"></path>
        </svg>
    </button>

    <script>
        // ============================================
        // MSAL Configuration - CHANGE THESE VALUES
        // ============================================
        const MSAL_CONFIG = {
            auth: {
                clientId: "b1438db9-79e6-457a-99fd-66e7ae4fe160",      // Your App Client ID
                authority: "https://login.microsoftonline.com/81dbb0d4-0d50-4aa5-a35c-04b98c73f3e0", // Your Tenant ID
                redirectUri: window.location.origin                     // Static Web App URL
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false
            }
        };

        const LOGIN_REQUEST = {
            scopes: ["openid", "profile", "User.Read"]
        };

        const GRAPH_REQUEST = {
            scopes: ["https://graph.microsoft.com/.default"]
        };

        // GROUP ID - Change this to your group's Object ID
        const ALLOWED_GROUP_ID = "622b603c-f4df-41cd-88fb-ea857d6ddf79";

        // ============================================
        // Initialize MSAL
        // ============================================
        const msalInstance = new msal.PublicClientApplication(MSAL_CONFIG);

        let currentAccount = null;
        let selectedProgramId = null;
        let programsData = {};

        // DOM Elements
        const loginView = document.getElementById("login-view");
        const filesView = document.getElementById("files-view");
        const unauthorizedView = document.getElementById("unauthorized-view");
        const loginButton = document.getElementById("login-button");
        const logoutButton = document.getElementById("logout-button");
        const logoutUnauthorizedButton = document.getElementById("logout-unauthorized-button");
        const loginHeaderButton = document.getElementById("login-header-button");
        const userInfo = document.getElementById("user-info");
        const usernameSpan = document.getElementById("username");
        const userAvatar = document.getElementById("user-avatar");
        const loginError = document.getElementById("login-error");
        const loadingSpinner = document.getElementById("loading-spinner");

        // ============================================
        // Initialize & Check Authentication
        // ============================================
        msalInstance.initialize().then(() => {
            handleRedirect();
            checkAuthStatus();
        }).catch(error => {
            console.error("MSAL initialization error:", error);
            showLoginView();
        });

        function handleRedirect() {
            msalInstance.handleRedirectPromise().then(response => {
                if (response) {
                    currentAccount = response.account;
                    msalInstance.setActiveAccount(currentAccount);
                    checkGroupMembership();
                }
            }).catch(error => {
                console.error("Redirect error:", error);
            });
        }

        function checkAuthStatus() {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                currentAccount = accounts[0];
                msalInstance.setActiveAccount(currentAccount);
                checkGroupMembership();
            } else {
                showLoginView();
            }
        }

        // ============================================
        // View Management
        // ============================================
        function showLoginView() {
            loginView.style.display = "flex";
            filesView.style.display = "none";
            unauthorizedView.style.display = "none";
            userInfo.style.display = "none";
            loginHeaderButton.style.display = "inline-block";
            logoutButton.style.display = "none";
        }

        function showFilesView() {
            loginView.style.display = "none";
            filesView.style.display = "block";
            unauthorizedView.style.display = "none";
            userInfo.style.display = "flex";
            loginHeaderButton.style.display = "none";
            logoutButton.style.display = "inline-block";
            updateUserUI();
            loadPrograms();
        }

        function showUnauthorizedView() {
            loginView.style.display = "none";
            filesView.style.display = "none";
            unauthorizedView.style.display = "flex";
            userInfo.style.display = "flex";
            loginHeaderButton.style.display = "none";
            logoutButton.style.display = "none";
            updateUserUI();
        }

        function updateUserUI() {
            if (currentAccount) {
                usernameSpan.textContent = currentAccount.name || currentAccount.username;
                const initials = (currentAccount.name || currentAccount.username)
                    .split(' ')
                    .map(n => n[0])
                    .join('')
                    .toUpperCase();
                userAvatar.textContent = initials;
            }
        }

        // ============================================
        // Authentication & Authorization
        // ============================================
        async function checkGroupMembership() {
            try {
                showLoginView();
                loadingSpinner.style.display = "block";
                loginError.style.display = "none";

                const token = await acquireToken();
                const isInGroup = await getUserGroupMembership(token);

                loadingSpinner.style.display = "none";

                if (isInGroup) {
                    showFilesView();
                } else {
                    showUnauthorizedView();
                }
            } catch (error) {
                console.error("Error checking group membership:", error);
                loadingSpinner.style.display = "none";
                loginError.textContent = `Error: ${error.message}`;
                loginError.style.display = "block";
                showLoginView();
            }
        }

        async function acquireToken() {
            try {
                const response = await msalInstance.acquireTokenSilent({
                    ...GRAPH_REQUEST,
                    account: currentAccount
                });
                return response.accessToken;
            } catch (error) {
                console.log("Silent token acquisition failed, trying popup...");
                const response = await msalInstance.acquireTokenPopup(GRAPH_REQUEST);
                return response.accessToken;
            }
        }

        async function getUserGroupMembership(accessToken) {
            try {
                const response = await fetch('https://graph.microsoft.com/v1.0/me/memberOf?$select=id', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Graph API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                // Check if user is member of the allowed group
                const userGroups = data.value.map(item => item.id);
                return userGroups.includes(ALLOWED_GROUP_ID);

            } catch (error) {
                console.error("Error fetching group membership:", error);
                throw error;
            }
        }

        // ============================================
        // Login & Logout
        // ============================================
        function login() {
            loginError.style.display = "none";
            loadingSpinner.style.display = "block";

            msalInstance.loginPopup(LOGIN_REQUEST).then(response => {
                currentAccount = response.account;
                msalInstance.setActiveAccount(currentAccount);
                loadingSpinner.style.display = "none";
                checkGroupMembership();
            }).catch(error => {
                console.error("Login error:", error);
                loadingSpinner.style.display = "none";
                loginError.textContent = `Login failed: ${error.errorCode || error.message}`;
                loginError.style.display = "block";
            });
        }

        function logout() {
            currentAccount = null;
            msalInstance.logoutPopup({
                mainWindowRedirectUri: window.location.origin
            }).catch(error => {
                console.error("Logout error:", error);
                showLoginView();
            });
        }

        // ============================================
        // Load Programs from JSON
        // ============================================
        async function loadPrograms() {
            try {
                const response = await fetch('programs.json');
                if (!response.ok) {
                    throw new Error(`Failed to load programs.json: ${response.status}`);
                }
                const data = await response.json();
                programsData = {};

                data.programs.forEach(program => {
                    programsData[program.id] = program;
                });

                generateProgramCards();
            } catch (error) {
                console.error("Error loading programs:", error);
                const filesList = document.getElementById('files-list');
                filesList.innerHTML = `<div class="status-message error">Error loading programs: ${error.message}</div>`;
            }
        }

        // ============================================
        // Generate Program Cards
        // ============================================
        function generateProgramCards() {
            const filesList = document.getElementById('files-list');
            filesList.innerHTML = '';

            Object.keys(programsData).forEach(programId => {
                const program = programsData[programId];
                const card = document.createElement('div');
                card.className = 'item-card';
                card.setAttribute('data-program-id', programId);

                const iconSvg = document.createElement('svg');
                iconSvg.className = 'item-icon';
                iconSvg.viewBox = '0 0 24 24';
                iconSvg.fill = 'currentColor';
                iconSvg.innerHTML = '<path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>';

                const textContainer = document.createElement('div');
                textContainer.style.flex = '1';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'item-name';
                nameDiv.textContent = program.name;

                const infoDiv = document.createElement('div');
                infoDiv.className = 'item-info';
                infoDiv.textContent = `Latest: ${program.lastVersion}`;

                textContainer.appendChild(nameDiv);
                textContainer.appendChild(infoDiv);

                card.appendChild(iconSvg);
                card.appendChild(textContainer);

                card.addEventListener('click', () => selectProgram(programId));

                filesList.appendChild(card);
            });
        }

        // ============================================
        // Select Program & Display Versions
        // ============================================
        function selectProgram(programId) {
            document.querySelectorAll('.item-card').forEach(card => {
                card.classList.remove('selected');
            });

            const selectedCard = document.querySelector(`[data-program-id="${programId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            selectedProgramId = programId;

            const programData = programsData[programId];
            if (programData) {
                document.getElementById('program-title').textContent = `${programData.name} - Versions`;

                // Latest version in first table
                const tbodyLatest = document.getElementById('versions-tbody-latest');
                tbodyLatest.innerHTML = '';

                if (programData.versions.length > 0) {
                    const latestVersion = programData.versions[0];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${latestVersion.program}</td>
                        <td>${latestVersion.version}</td>
                        <td><a href="${latestVersion.link}" target="_blank">Download</a></td>
                        <td><a href="${latestVersion.releaseNote}" target="_blank">View Release Note</a></td>
                    `;
                    tbodyLatest.appendChild(row);
                }

                // Obsolete versions in second table
                const tbodyObsolete = document.getElementById('versions-tbody-obsolete');
                tbodyObsolete.innerHTML = '';

                for (let i = 1; i < programData.versions.length; i++) {
                    const version = programData.versions[i];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${version.program}</td>
                        <td>${version.version}</td>
                        <td><a href="${version.link}" target="_blank">Download</a></td>
                        <td><a href="${version.releaseNote}" target="_blank">View Release Note</a></td>
                    `;
                    tbodyObsolete.appendChild(row);
                }

                document.getElementById('program-details').classList.add('visible');
            }
        }

        function backToPrograms() {
            document.getElementById('program-details').classList.remove('visible');
            document.querySelectorAll('.item-card').forEach(card => {
                card.classList.remove('selected');
            });
            selectedProgramId = null;
        }

        // ============================================
        // Event Listeners
        // ============================================
        loginButton.addEventListener('click', login);
        logoutButton.addEventListener('click', logout);
        logoutUnauthorizedButton.addEventListener('click', logout);
        loginHeaderButton.addEventListener('click', login);

        document.getElementById('back-button').addEventListener('click', backToPrograms);

        const helpButton = document.getElementById('help-button');
        if (helpButton) {
            helpButton.addEventListener('click', () => {
                window.open('https://munters-aei.zendesk.com/hc/en-us/requests/new?ticket_form_id=18575973794588', '_blank');
            });
        }
    </script>
</body>

</html>
