<html>

<head>
    <title>Download center</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <div class="logo">
            <img src="logo.png" alt="Logo">
            <h1>Download Center</h1>
        </div>
        <div id="user-section" class="user-section">
            <div id="user-info" class="user-info" style="display: none;">
                <div class="user-avatar" id="user-avatar">U</div>
                <span id="username">User</span>
            </div>
            <div class="action-buttons">
                <button id="login-header-button" style="display: none;" onclick="login()">Login</button>
                <button id="logout-button" style="display: none;">Logout</button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div id="login-view" class="login-container">
            <div class="login-card">
                <h2 class="login-title">Welcome to AEI Download Center</h2>
                <p>Please sign in to access files.</p>
                <div id="login-error" class="status-message"></div>
                <button id="login-button" class="login-button" onclick="login()">Sign In with Microsoft</button>
                <p class="login-message">Secure access to support resources.</p>
            </div>
        </div>

        <div id="files-view" style="display: none;">
            <h1 class="page-title">Programs</h1>
            <div id="breadcrumb-nav" class="breadcrumb-nav"></div>

            <div class="controls-container">
                <div class="search-box">
                    <div class="search-container">
                        <input type="text" class="search-input" placeholder="Search for files and folders..."
                            id="search-input">
                        <button class="search-button" aria-label="Search">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                viewBox="0 0 16 16">
                                <path
                                    d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div id="file-operation-status" class="status-message"></div>

            <div class="programs-container">
                <div id="files-list" class="file-grid">
                    <!-- Cards will be generated dynamically from programs.json -->
                </div>

                <div id="program-details" class="program-details">
                    <h2 id="program-title">Program Versions</h2>
                    <table class="versions-table versions-table-latest">
                        <thead>
                            <tr>
                                <th>Program</th>
                                <th>Version</th>
                                <th>Link</th>
                                <th>Release note</th>
                            </tr>
                        </thead>
                        <tbody id="versions-tbody-latest">
                            <!-- Latest version will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                    <h3 style="margin-top: 30px; margin-bottom: 15px; color: #333; font-size: 1.1rem;">Previous</h3>
                    <table class="versions-table versions-table-obsolete">
                        <thead>
                            <tr>
                                <th>Program</th>
                                <th>Version</th>
                                <th>Link</th>
                                <th>Release note</th>
                            </tr>
                        </thead>
                        <tbody id="versions-tbody-obsolete">
                            <!-- Obsolete versions will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                    <button class="back-button" id="back-button">‚Üê Back to Programs</button>
                </div>
            </div>
        </div>
    </main>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">Confirm Deletion</h3>
            <p id="confirm-message" class="modal-message">Are you sure you want to delete this item?</p>
            <div class="modal-buttons">
                <button id="modal-cancel" class="modal-cancel">Cancel</button>
                <button id="modal-delete" class="modal-delete">Delete</button>
            </div>
        </div>
    </div>

    <!-- Help Button -->
    <button id="help-button" class="help-button" title="Help" type="button">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"></path>
            <path
                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z">
            </path>
        </svg>
    </button>

    <script>
        // Auth config will be loaded from `auth-config.json` to keep secrets/IDs isolated.
        // auth-config.json contains: clientId, objectId, tenantId, allowedGroupId
        let AUTH_CONFIG = null;
        let msalInstance = null;
        let currentAccount = null;
        let programsData = {};
        let selectedProgramId = null;
        let ALLOWED_GROUP_ID = null;

        // Use explicit Graph delegated scopes for SPA
        const loginRequest = {
            scopes: ["User.Read", "GroupMember.Read.All"]
        };

        const tokenRequest = {
            // Request delegated Graph scopes required to call /me/memberOf
            scopes: ["User.Read", "GroupMember.Read.All"]
        };

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('login-error') || document.getElementById('file-operation-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `status-message ${type}`;
                statusEl.style.display = 'block';
            }
            console.log(`[${type}] ${message}`);
        }

        async function loadAuthConfig() {
            try {
                const res = await fetch('auth-config.json');
                if (!res.ok) throw new Error('Failed to fetch auth-config.json');
                AUTH_CONFIG = await res.json();

                if (!window.msal) {
                    throw new Error('MSAL library not loaded. Check that msal-browser.min.js loaded successfully.');
                }

                const msalConfig = {
                    auth: {
                        clientId: AUTH_CONFIG.clientId,
                        authority: `https://login.microsoftonline.com/${AUTH_CONFIG.tenantId}`,
                        redirectUri: window.location.origin,
                        postLogoutRedirectUri: window.location.origin
                    },
                    cache: { cacheLocation: 'sessionStorage' }
                };

                msalInstance = new window.msal.PublicClientApplication(msalConfig);
                ALLOWED_GROUP_ID = AUTH_CONFIG.allowedGroupId;
                console.log('MSAL initialized');
            } catch (err) {
                console.error('Error in loadAuthConfig:', err);
                showStatus('Failed to load auth config. Check console.', 'error');
                throw err;
            }
        }

        async function handleRedirectPromise() {
            try {
                if (!msalInstance) return;
                const response = await msalInstance.handleRedirectPromise();
                if (response) {
                    currentAccount = response.account;
                    msalInstance.setActiveAccount(currentAccount);
                } else {
                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length > 0) {
                        currentAccount = accounts[0];
                        msalInstance.setActiveAccount(currentAccount);
                    }
                }
            } catch (err) {
                console.error('handleRedirectPromise error:', err);
            }
        }

        // Function to generate program cards dynamically
        function generateProgramCards() {
            const filesList = document.getElementById('files-list');
            filesList.innerHTML = ''; // Clear any existing cards

            Object.keys(programsData).forEach(programId => {
                const program = programsData[programId];
                const card = document.createElement('div');
                card.className = 'item-card';
                card.setAttribute('data-program-id', programId);

                const folderIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 4H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H5V8h14v10z" />
                </svg>`;

                const lastVersion = program.versions && program.versions.length > 0
                    ? program.versions[0].version
                    : 'N/A';

                card.innerHTML = `
                    <div class="folder-icon">
                        ${folderIcon}
                    </div>
                    <div class="item-name">${program.name}</div>
                    <div class="item-info">Last version: ${lastVersion}</div>
                `;

                // Add click listener
                card.addEventListener('click', () => {
                    selectProgram(programId);
                });

                filesList.appendChild(card);
            });
        }

        // Load programs data from JSON file
        function loadProgramsData() {
            fetch('programs.json')
                .then(response => response.json())
                .then(data => {
                    // Convert array to object keyed by program id
                    data.programs.forEach(program => {
                        programsData[program.id] = {
                            name: program.name,
                            versions: program.versions
                        };
                    });
                    // Generate cards after data is loaded
                    generateProgramCards();
                })
                .catch(error => {
                    console.error('Error loading programs.json:', error);
                    alert('Error loading programs data. Please make sure programs.json is in the same directory.');
                });
        }

        function selectProgram(programId) {
            // Remove selected from all cards
            document.querySelectorAll('.item-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Add selected to clicked card
            const selectedCard = document.querySelector(`[data-program-id="${programId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            selectedProgramId = programId;

            // Display program details
            const programData = programsData[programId];
            if (programData) {
                document.getElementById('program-title').textContent = `${programData.name} - Versions`;

                // Populate table with latest version
                const tbodyLatest = document.getElementById('versions-tbody-latest');
                tbodyLatest.innerHTML = '';

                if (programData.versions.length > 0) {
                    const latestVersion = programData.versions[0];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${latestVersion.program}</td>
                        <td>${latestVersion.version}</td>
                        <td><a href="${latestVersion.link}" target="_blank">Download</a></td>
                        <td><a href="${latestVersion.releaseNote}" target="_blank">View Release Note</a></td>
                    `;
                    tbodyLatest.appendChild(row);
                }

                // Populate table with obsolete versions
                const tbodyObsolete = document.getElementById('versions-tbody-obsolete');
                tbodyObsolete.innerHTML = '';

                for (let i = 1; i < programData.versions.length; i++) {
                    const version = programData.versions[i];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${version.program}</td>
                        <td>${version.version}</td>
                        <td><a href="${version.link}" target="_blank">Download</a></td>
                        <td><a href="${version.releaseNote}" target="_blank">View Release Note</a></td>
                    `;
                    tbodyObsolete.appendChild(row);
                }

                // Show details section
                document.getElementById('program-details').classList.add('visible');
            }
        }

        function backToPrograms() {
            document.getElementById('program-details').classList.remove('visible');
            document.querySelectorAll('.item-card').forEach(card => {
                card.classList.remove('selected');
            });
            selectedProgramId = null;
        }

        // MSAL Authentication Functions
        async function checkAuth() {
            if (!currentAccount) {
                updateUIForLogout();
            } else {
                msalInstance.setActiveAccount(currentAccount);
                await checkGroupMembership();
            }
        }

        async function checkGroupMembership() {
            try {
                const token = await getToken();
                const response = await fetch("https://graph.microsoft.com/v1.0/me/memberOf", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to get group membership: ${response.statusText}`);
                }

                const data = await response.json();
                const groups = data.value.map(item => item.id);

                if (groups.includes(ALLOWED_GROUP_ID)) {
                    // User is in the allowed group
                    updateUIForLogin(currentAccount);
                    loadProgramsData();
                } else {
                    // User not in allowed group
                    console.log("User not in allowed group");
                    updateUIForLogout();
                    showUnauthorized();
                }
            } catch (error) {
                console.error("Group membership check error:", error);
                updateUIForLogout();
            }
        }

        async function getToken() {
            try {
                const account = currentAccount || msalInstance.getActiveAccount();
                const silentRequest = Object.assign({}, tokenRequest, { account });
                const response = await msalInstance.acquireTokenSilent(silentRequest);
                return response.accessToken;
            } catch (error) {
                if (error instanceof msal.InteractionRequiredAuthError) {
                    try {
                        const account = currentAccount || msalInstance.getActiveAccount();
                        const popupRequest = Object.assign({}, tokenRequest, { account });
                        const response = await msalInstance.acquireTokenPopup(popupRequest);
                        return response.accessToken;
                    } catch (popupError) {
                        console.error("Popup error:", popupError);
                        throw popupError;
                    }
                } else {
                    console.error("Token acquisition error:", error);
                    throw error;
                }
            }
        }

        function login() {
            if (!msalInstance) {
                showStatus('MSAL not initialized. Check console.', 'error');
                return;
            }
            msalInstance.loginRedirect(loginRequest);
        }

        function logout() {
            if (msalInstance) {
                msalInstance.logoutRedirect();
            }
        }

        function updateUIForLogin(account) {
            document.getElementById("login-view").style.display = "none";
            document.getElementById("files-view").style.display = "block";
            document.getElementById("user-info").style.display = "flex";
            document.getElementById("login-header-button").style.display = "none";
            document.getElementById("logout-button").style.display = "inline-block";
            document.getElementById("username").textContent = account.name || account.username;
            const initials = account.name ? account.name.split(' ').map(n => n[0]).join('').substring(0, 2) : account.username.charAt(0);
            document.getElementById("user-avatar").textContent = initials.toUpperCase();
            document.getElementById("help-button").style.display = "flex";
        }

        function updateUIForLogout() {
            document.getElementById("login-view").style.display = "flex";
            document.getElementById("files-view").style.display = "none";
            document.getElementById("user-info").style.display = "none";
            // Show header login button so user can access Sign In from header
            const loginHeaderBtn = document.getElementById("login-header-button");
            if (loginHeaderBtn) loginHeaderBtn.style.display = "inline-block";
            document.getElementById("logout-button").style.display = "none";
            document.getElementById("help-button").style.display = "none";
        }

        function handleLogoutSuccess() {
            currentAccount = null;
            msalInstance.setActiveAccount(null);
            updateUIForLogout();
            document.getElementById('files-list').innerHTML = '';
            document.getElementById('breadcrumb-nav').innerHTML = '';
        }

        function showUnauthorized() {
            const filesList = document.getElementById('files-list');
            filesList.innerHTML = '<div class="status-message error" style="display: block; padding: 20px; text-align: center;">Access Denied: You do not have permission to access this resource.</div>';
        }

        function showStatusMessage(message, type = 'info', elementId = 'file-operation-status') {
            const statusEl = document.getElementById(elementId);
            if (!statusEl) return;
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
        }

        function clearStatusMessage(elementId = 'file-operation-status') {
            const statusEl = document.getElementById(elementId);
            if (!statusEl) return;
            statusEl.textContent = '';
            statusEl.style.display = 'none';
            statusEl.className = 'status-message';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                showStatus('Loading authentication...');
                await loadAuthConfig();
                await handleRedirectPromise();
                await checkAuth();

                // Bind event listeners
                const loginBtn = document.getElementById('login-button');
                const loginHeaderBtn = document.getElementById('login-header-button');
                const logoutBtn = document.getElementById('logout-button');
                const backBtn = document.getElementById('back-button');
                const helpBtn = document.getElementById('help-button');

                if (loginBtn) loginBtn.addEventListener('click', login);
                if (loginHeaderBtn) loginHeaderBtn.addEventListener('click', login);
                if (logoutBtn) logoutBtn.addEventListener('click', logout);
                if (backBtn) backBtn.addEventListener('click', backToPrograms);

                if (helpBtn) {
                    helpBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        window.open('https://munters-aei.zendesk.com/hc/en-us/requests/new?ticket_form_id=18575973794588', '_blank');
                    });
                }

                const searchInput = document.getElementById('search-input');
                const searchButton = document.querySelector('.search-button');
                if (searchInput && searchButton) {
                    searchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            showStatus('Search not yet implemented', 'info');
                        }
                    });
                    searchButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        showStatus('Search not yet implemented', 'info');
                    });
                }

                const modalCancel = document.getElementById('modal-cancel');
                const confirmModal = document.getElementById('confirm-modal');
                if (modalCancel) {
                    modalCancel.addEventListener('click', () => {
                        confirmModal.style.display = 'none';
                    });
                }

                showStatus('Ready.');
            } catch (error) {
                console.error(error);
                showStatus('Initialization failed. Check console.', 'error');
            }
        });
    </script>

</body>

</html>